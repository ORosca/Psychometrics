---
title: "2PL IRT Models for IES DAACS Mathematics Assessment (v.2.0, 174 Items), May 2022 - May 2023, umgc1-and-ua2 Combined Sample, AnSamp1, n = 4460" 
author: "Oxana Rosca"
date: "`r Sys.Date()`"
output:
  word_document:
    toc: true
    toc_depth: 6
    reference_docx: "C:/Users/orosc/OneDrive - University at Albany - SUNY/My DAACS/WordDocMarkdownTemplate.docx"
  html_document:
    toc: true
    toc_depth: 6
    theme: readable
---

# Purpose: Concurrent Item Response Theory (IRT) Analyses of DAACS Math Assessment Scores from the Analytic Sample 1 Using DAACS Math Assessment in May 2022 - May 2023 (first attempt, nonspeedy, treatment, UMGC1 and UAlbany2). 174 items were diivided in three sub-pools by the level of assigned difficulty. IES project, 2022-2023. 

# RQ: How well do the 174 math items fit the unidimensional 2PL IRT model?

# Results: The 159-item pool has acceptable parameters and fits better than the complete
pool of items (k = 174). 
15 items with poor a-parameters (< 0.3 and > 4)) and/or b-parameters (> 6 ) were 
removed. The remaining 159 items have a good fit to unidimensional 2PL IRT model.

# Assessment: DAACS Math Assessment 
The DAACS Math Assessment consists of 174 math items from a pool of items (k = 174). Each student completed either 18 items (k_admin_min = 18) or 24 items (k_admin_max = 24) during their first attempt. For the 2022–2023 data collection, we implemented an adaptive multistage testing design, with item difficulty levels assigned by state standards and expert evaluations.

# Participants 
A total of 5447 participants completed at least one DAACS assessment, including 4152 (76.2%) from UMGC1 and 1295 from UA2. All participants had both a DAACS-assigned ID (DAACS_ID) and an institution-assigned ID.
For the math assessment specifically, 4621 students participated : 3869 (83.7%) UMGC1 and 752 UA2.

## Analytic Samples

### Analytic Sample 1 (AnSamp1), n = 4460
  Purpose: For IRT analyses.
  Composition: Includes first-attempt scores from 3713 (83.3%) UMGC1 and 747 (16.7%) UA2 non-speedy respondents.
  Data: Collected between May 2022 and May 2023, including all non-speedy respondents' math scores from their first attempts.	
The dataset "math.itemsONLY_AnSamp1" includes 174 items' scores (Q001–Q174) but excludes student IDs and other variables.
A detailed dataframe "math.items_AnSamp1" includes 194 columns:174 item scores, 2 ID variables,	18 personal variables, such as math total scores, dichotomous variables (e.g., gender, age group [below or above 24 years], and college [UMGC or UA2]).

To facilitate IRT analyses, the item-level datasets were created at the two colleges using:
  The same number of items (k = 174).
  The same item order for both UMGC and UA2 students.
  DAACS student data (scores) and institution-provided data (personal and academic information).
The item-level dataframes from the two colleges were combined into a single dataset, "math.items_AnSamp1", a shortened title for the complete dataframe "math.items1stAtt_wide_nsp_umgc1ua2_wPersonal" (n = 4460; Numgc = 3713; Nua = 747).

The speedy respondents (who took ≤ 180 seconds for 18 items), those in the control group, enrolled in 2023, or took the DAACS Math assessment after their first semester were removed from the Analytic Sample 1.

A subset of item-level scores, "math.itemsONLY_AnSamp1" was also created from "math.items_AnSamp1." This subset contains only item scores (Q001–Q174) and excludes student IDs and other variables.

# R-packages
```{r}
library(car)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(janitor)
library(mirt)
library(openxlsx)
library(psych)
library(data.table)
library(tidyr)
```

# Data 
"math.items_AnSamp1" (n = 4460, Numgc = 3713, Nua = 747) includes the first-attempt scores from non-speedy respondents, who took DAACS Math assessment in May 2022 - May 2023. 

The df "math.itemsONLY_AnSamp1" includes 174 items' scores (Q001-Q174) and does not contain students' IDs nor other variables. 
Load the files with clean data from math assessment
```{r}
#Load the files with clean math data 
#load("D:/Dropbox/DAACS-Validity/Analyses/Math/Math_dataClean-UMGC1UA2_1.RData")
load("C:/Users/orosc/OneDrive - University at Albany - SUNY/My DAACS/math/Math_dataClean-umgc1ua2_1.RData")
#load("E:/OneDrive - University at Albany - SUNY/My DAACS/math/Math_dataClean-umgc1ua2_1.RData")
```

## Analytic Sample 1: 194 columns for 4460 non-speedy respondents: 174 item-scores + 2 ID 
variables + 18 personal variables: math total scores, dichotomous variables of 
gender, age (below or above 24 y.o.), and college (UMGC or UAlbany), etc., are 
present in the following dataframe
```{r}
# A long self-explanatory title
dim(math.items1stAtt_wide_nsp_umgc1ua2_wPersonal) 
# 4460  194
# A short title
dim(math.items_AnSamp1)  # 4460  194
# Only items' QIDs
dim(math.itemsONLY_AnSamp1)  # 4460  174
```

###  College: Numgc1 = 3713 (83.3%), Nua2 = 747 
```{r} 
math.items_AnSamp1$college %>% table(useNA = "always") %>%
                        prop.table() %>% round(4)
```

### Age: Adult Undergrads (AUS ≥ 24 y.o.) = 647 sts (40%), Traditional College Age 
undergrads (TCAUS < 24 y.o. ) = 970 (60%) sts
```{r}
table_tmp<-table(math.items_AnSamp1$Age_d24)
table_tmp
round(prop.table(table_tmp), 4)
```

### 174 Items' QIDs (variables' names): numerical order from Q001 up to Q174
```{r}
#### Column names are in alphabetical order
# # Define the function
# is_alphabetical <- function(data) {
#   if (!is.data.frame(data)) {
#     stop("Input must be a data frame.")
#   }
#   identical(names(data), sort(names(data)))
# }
# Test the df
print(is_alphabetical(math.itemsONLY_AnSamp1))

# Check if column names are in increasing order
all(diff(as.numeric(gsub(
  "Q", "", names(math.itemsONLY_AnSamp1)))) > 0) 
```

#### All items are dichotomous
```{r}
n <- nrow(math.itemsONLY_AnSamp1) #people
n <- ncol(math.itemsONLY_AnSamp1) #items
numberOfCategories_tmp <- rep(0,n)
for (j in 1:n) {
	numberOfCategories_tmp[j] <- sum(table(math.itemsONLY_AnSamp1[,j]) >= 0)
}
max(numberOfCategories_tmp)
min(numberOfCategories_tmp)
```

#### Items' Descriptive Statistics (k = 174 items) are in 
"R.02.IRT_IES_Math Items UniModels_umgc1ua2_Results.xlsx",
"math.itemsONLY_AnSamp1.describe.csv"
"math.itemsONLY_AnSamp1_umgc1.describe.csv",
"math.itemsONLY_AnSamp1_ua2.describe.csv",   or in 
```{r}
# math.itemsONLY_AnSamp1.describe <- describe(math.itemsONLY_AnSamp1)
# math.itemsONLY_AnSamp1_umgc1.describe <-
#   describe(math.items_AnSamp1[math.items_AnSamp1$college == "UMGC1", 21:194])
# math.itemsONLY_AnSamp1_ua2.describe<-
#   describe(math.items_AnSamp1[math.items_AnSamp1$college == "UA2", 21:194])
```

#####  189-1482 students per item 
```{r}
# math.itemsONLY_AnSamp1.describe <- describe(math.itemsONLY_AnSamp1)

min(math.itemsONLY_AnSamp1.describe$n) # 189
max(math.itemsONLY_AnSamp1.describe$n) # 1482
```

To-do: Function to create stacked bar charts for two groups (colleges) of students 

##### Items' vertical bar charts: 94932 items were responded to by non-speedy respondents: 
54351 (57.3%) correct and 40581 wrong
```{r}
# Subset 174 items and DAACS_ID, AnSample1, n = 4460
math.items1stAtt_wide_AnSamp1 <- 
  math.items_AnSamp1[, c(7, 21:194)] # 4460  175
dim(math.items1stAtt_wide_AnSamp1)
```

Create a LONG item-level file (with a single row for every response, n = 94932) 
```{r}
# wide-to-long restructure 
# library(data.table)
library(data.table)
math.items1stAtt_long_AnSamp1 <- melt(setDT(math.items1stAtt_wide_AnSamp1), id.vars = "DAACS_ID", na.rm = TRUE)

names(math.items1stAtt_long_AnSamp1) <- c('DAACS_ID', 'qid', 'score')
dim(math.items1stAtt_long_AnSamp1) # 94932  3
head(math.items1stAtt_long_AnSamp1)
```

The chart includes labels with the exact number of observations on each bar:
```{r}
ggplot(math.items1stAtt_long_AnSamp1, aes(x = as.logical(score))) +
  geom_bar() +
  geom_text(stat = 'count', aes(label = after_stat(count)), vjust = -0.5) + 
  xlab('Answered Correctly') + 
  ylab('')

# Save the plot as a PDF
ggsave(filename = 
"Math Items Bar Plot_Total correct and wrong Responses_AnSamp1.pdf")
```

Since 174 plots are too many for the given format, create the bar plots in 
console (in Plots plane of R-Studio) and save as 
"Math Items Bar Plots Correct Responses_AnSamp1.pdf". 
See "174 math Items Summary.html" for the horizontal bar-plots.
```{r}
#library(ggplot2)

# Ensure score is binary (e.g., TRUE/FALSE or 1/0)
math.items1stAtt_long_AnSamp1$score <- as.logical(math.items1stAtt_long_AnSamp1$score)

# Run in console
ggplot(math.items1stAtt_long_AnSamp1, aes(x = score)) +
  geom_bar() +
  facet_wrap(~ qid, scales = "free_y") + # Adjust scales if necessary
  xlab('Answered Correctly') +
  ylab('Response Count') +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
ggsave(
filename = "Math Items Bar Plots Correct Responses_AnSamp1.pdf")
head(math.items1stAtt_long_AnSamp1)
```

#### Items' Difficulty Levels assigned using states' and experts' documentation
Create grouping vectors that assign difficulty levels to the math items 
```{r}
math_MEDIUM_items1stAtt_vector <- 
  math.items_long_ua2[math.items_long_ua2$difficulty =='MEDIUM',]$qid|> unique()
math_EASY_items1stAtt_vector <- 
  math.items_long_ua2[math.items_long_ua2$difficulty == 'EASY',]$qid |> unique()
math_HARD_items1stAtt_vector <- 
  math.items_long_ua2[math.items_long_ua2$difficulty == 'HARD',]$qid |> unique()
math_MEDIUM_items1stAtt_vector<-sort(math_MEDIUM_items1stAtt_vector)
math_EASY_items1stAtt_vector<-sort(math_EASY_items1stAtt_vector)
math_HARD_items1stAtt_vector<-sort(math_HARD_items1stAtt_vector)
```

##### 195 sts (4.4%) took medium, easy, AND hard items; 1443 sts (32.4%) took medium and easy items;
1853 sts (41.6%) took medium and hard items; 969 sts (21.7%) took medium items only
```{r}
# Create a new column 'itemsTaken' with default value 'medium 
math.items_AnSamp1$itemsTaken <- 'medium'
# Move the new column to the begining of the data frame
math.items_AnSamp1<-
  math.items_AnSamp1[,c(1:12,195,13:194)]

# Identify sts who attended to at least one easy item
easyItemsTakers <- 
	rowSums(math.items_AnSamp1[
	  ,math_EASY_items1stAtt_vector],na.rm = TRUE)>0

# Identify sts who attended to at least one hard item
hardItemsTakers <- 
	rowSums(math.items_AnSamp1[
	  , math_HARD_items1stAtt_vector],na.rm = TRUE)>0

# Update 'itemsTaken' column based on conditions
math.items_AnSamp1$itemsTaken[
  easyItemsTakers & !hardItemsTakers] <- 
	'easy_medium'
math.items_AnSamp1$itemsTaken[
  hardItemsTakers & !easyItemsTakers] <- 
	'hard_medium'
math.items_AnSamp1$itemsTaken[
  easyItemsTakers & hardItemsTakers] <- 
	'hard_easy_medium'

math.items_AnSamp1$itemsTaken %>% table(useNA = "always") %>%
                        prop.table() %>% round(4)
```

###### Maximum and minimum total score in each group of itemsTaken 
Descriptive statistics by group
group: easy_medium
vars    n mean   sd median trimmed  mad  min  max range skew kurtosis se
X1   1443 0.37 0.12   0.38    0.36 0.12 0.06 0.71  0.65 0.07    -0.31  0

group: hard_easy_medium
vars   n mean   sd median trimmed  mad  min  max range  skew kurtosis   se
X1   195 0.52 0.09    0.5    0.52 0.12 0.29 0.71  0.42 -0.13     -0.4 0.01

group: hard_medium
vars    n mean   sd median trimmed  mad  min max range  skew kurtosis se
X1   1853 0.74 0.12   0.75    0.74 0.12 0.25   1  0.75 -0.08    -0.22  0

group: medium
vars   n mean   sd median trimmed  mad  min  max range  skew kurtosis se
X1   969 0.57 0.11   0.56    0.57 0.08 0.06 0.78  0.72 -0.81     2.24  0
```{r}
# library(psych)
mathTotal_by_itemsTaken_table <- describeBy(math.items_AnSamp1$mathTotal,
			   math.items_AnSamp1$itemsTaken)
mathTotal_by_itemsTaken_table
```

##### Items' Bar Plots groupped in difficulty levels
See the plots in math.items_umgc1ua2_UnidimIRT_All Plots_2022data.docx
Add a new column for difficulty level
```{r}
math.items1stAtt_long_AnSamp1$difficulty <- 
	ifelse(math.items1stAtt_long_AnSamp1$qid %in% 
	         math_EASY_items1stAtt_vector, "Easy",
	ifelse(math.items1stAtt_long_AnSamp1$qid %in% 
	         math_MEDIUM_items1stAtt_vector, "Medium",
	ifelse(math.items1stAtt_long_AnSamp1$qid %in% 
	         math_HARD_items1stAtt_vector, "Hard", NA)))

# Filter LONG data for each difficulty level (Subset three datasets) 
math.items1stAtt_long_umgc1ua2_EASYwIDs <- 
  math.items1stAtt_long_AnSamp1[
    math.items1stAtt_long_AnSamp1$difficulty == "Easy", ]
math.items1stAtt_long_umgc1ua2_MEDIUMwIDs <- 
  math.items1stAtt_long_AnSamp1[
    math.items1stAtt_long_AnSamp1$difficulty == "Medium", ]
math.items1stAtt_long_umgc1ua2_HARDwIDs <- 
  math.items1stAtt_long_AnSamp1[
    math.items1stAtt_long_AnSamp1$difficulty == "Hard", ]
```

###### Easy Items 
with Adjusted Font Sizes
```{r}
ggplot(math.items1stAtt_long_umgc1ua2_EASYwIDs, aes(x = as.logical(score))) +
  geom_bar() +
  facet_wrap(~ qid, scales = "free") +
  xlab('Answered Correctly') + ylab('') +
  theme(
    text = element_text(size = 10), # Adjust the general text size
    strip.text = element_text(size = 8) # Adjust facet label text size
  )
# Save the plot as a PDF
ggsave(
  filename = "Math Easy Items Bar Plots_AnSamp1.pdf",
  height = 8, width = 11  # Adjust the dimensions if needed
)
``` 

###### Medium Items 
with Adjusted Font Sizes
```{r}
ggplot(math.items1stAtt_long_umgc1ua2_MEDIUMwIDs, aes(x = as.logical(score))) +
  geom_bar() +
  facet_wrap(~ qid, scales = "free") +
  xlab('Answered Correctly') + ylab('') +
  theme(
    text = element_text(size = 10), # Adjust the general text size
    strip.text = element_text(size = 8) # Adjust facet label text size
  )
# Save the plot as a PDF
ggsave(
  filename = "Math Medium Items Bar Plots_AnSamp1.pdf",
  height = 8, width = 11  # Adjust the dimensions if needed
)
```

###### Hard Items 
```{r}
ggplot(math.items1stAtt_long_umgc1ua2_HARDwIDs, aes(x = as.logical(score))) +
  geom_bar() +
  facet_wrap(~ qid, scales = "free") +
  xlab('Answered Correctly') + ylab('') +
  theme(
    text = element_text(size = 10), # Match font size to others
    strip.text = element_text(size = 8)
  )
# Save the plot as a PDF
ggsave(
  filename = "Math Hard Items Bar Plots_AnSamp1.pdf",
  height = 8, width = 11
)
```

To Do: empirical plots; does not work with NAs.
Empirical Plots works only for unidimensional tests with monotonically increasing
item response functions.If monotonicity is not true for all items, however, then
these plots may serve as a visual diagnostic tool so long as the majority of
items are indeed monotonic.
Generate the empirical plots for 174 items to obtain observed proportions by
response input: Function to create stacked bar charts for two groups (colleges) 
of sts.
To generate the empirical plots for 174 items to obtain observed proportions
by response input, separate the sets of items first, like you did for the
parallel analyses.
To obtain observed proportions by response input, inspect the empirical plots
(per single item). Loop through all items to generate the empirical individual
item plots with reduced total score (i.e.,the total score without that item) on
the x-axis (doesn't work due to NAs):
```{r}
# library(mirt)
# for (i in 1:ncol(math.itemsONLY_AnSamp1)) {
#     print(i)
#     plot <- empirical_plot(math.itemsONLY_AnSamp1, i)
#     print(plot)
# }
```
 

#### Students Overlap across item-sets 
An important requirement of a concurrent IRT analysis of several Sets of items 
is to have common students for each pair of sets of items.
For some pairs of the sets there are no common test-taker, for example, the set 
of items Q097-Q102 has no common students with the set of items Q007-Q012. 
However, both of those sets share the students with other sets like Q091-Q096 
and many others. In such a way each set of items is interconnected with all 
other sets.
To test this requirement, create an item-sample dataframe with 29 items that 
represent 29 math sets. For example, sample the first item from each set of items:
```{r}
math.items_wide_AnSamp1_1stItems <-
	math.itemsONLY_AnSamp1[, c(1,7,13,19,25,31,37,43,49,55,61,
	           67,73,79,85,91,97,103,109,115,121,127,133,139,145,151,157,163,169)]
# Create an empty matrix to store the results
final_tmp <- 
  matrix(0, nrow = ncol(math.items_wide_AnSamp1_1stItems), 
						ncol = ncol(math.items_wide_AnSamp1_1stItems))
# Iterate through each combination of items and count how many sts responded 
# to both items
for (i in 1:ncol(math.items_wide_AnSamp1_1stItems)) {
	for (j in 1:ncol(math.items_wide_AnSamp1_1stItems)) {
		# Count how many sts responded to both items (excluding NA values)
		final_tmp[i, j] <- 
			sum(!is.na(math.items_wide_AnSamp1_1stItems[, i]) & 
					!is.na(math.items_wide_AnSamp1_1stItems[, j]))
	}
}
# Convert the result matrix to a data frame with row and column names
MathSet_Overlap_AnSamp1 <- as.data.frame(final_tmp)
rownames(MathSet_Overlap_AnSamp1) <- 
	colnames(math.items_wide_AnSamp1_1stItems)
colnames(MathSet_Overlap_AnSamp1) <- 
	colnames(math.items_wide_AnSamp1_1stItems)
# Print the table; see it in 
#R.02.IRT_IES_Math Items UniModels_umgc1ua2_Results.exl, tab "Sets-sts Overlap"
print(MathSet_Overlap_AnSamp1) 
write.table(MathSet_Overlap_AnSamp1, 'math.items_AnSamp1umgc1ua2_SetStudentOverlap_matrix.csv', sep = ',')
```

# IRT Analyses of Mathematics Items using Unidimensional Models (without grouping in testlets)
Unidimensional Models = One-factor Models

## Save the DAACS_ID vector before running the models
```{r}
math.items_AnSamp1DAACS_ID_vector <-  math.items_AnSamp1$DAACS_ID
```

## All-174-Items Unimodels: the 2PL model fits better than 1PL model  
Run every model using the MHRM type of SE (for stochastic approximations of 
observed information matrix based on the Robbins-Monro filter or a fixed number 
of MHRM draws without the RM filter).
The 2PL model fits better than the 1PL model (see ANOVA t-test for nested models).

### 1PL Model: All Items type = 1PL 
Rename (save with a new name) the dataset to define the number of items 
```{r}
math.items_174_umgc1ua2<-math.itemsONLY_AnSamp1

# mathUnimodel1PL174 <- mirt(math.items_174_umgc1ua2,
#                            model = 1,
#                            itemtype = 'Rasch',
#                            method = 'MHRM', SE = TRUE,
#                            SE.type = 'MHRM',
#                            # technical = list(NCYCLES = 1000),
#                            TOL = 1e-03,
#                            verbose = TRUE)
mathUnimodel1PL174
extract.mirt(mathUnimodel1PL174,"converged")
```

### 2PL Model: All Items type = 2PL 
```{r}
# mathUnimodel2PL174 <- mirt(math.items_174_umgc1ua2,
#                            model = 1,
#                            itemtype = '2PL',
#                            method = 'MHRM', SE = TRUE,
#                            SE.type = 'MHRM',
#                            # technical = list(NCYCLES = 1000),
#                            TOL = 1e-03,
#                            verbose = TRUE)
mathUnimodel2PL174
extract.mirt(mathUnimodel2PL174,"converged")
```

### ANOVA: 2PL Model fits better than 1PL (ANOVA t-test for nested models)
```{r}
anova(mathUnimodel1PL174,mathUnimodel2PL174)
```

### Local Dependency Q3 Residuals  
```{r}
# Q3 summary statistics
mathUnimodel2PL174_Residuals_Q3<-
  residuals(mathUnimodel2PL174, type='Q3')
```

### Parameters for 2PL Model: 15 items have a<0.3, and 2 of them have b>6; 6% (24 out 174) of items discriminate weakly (a-par < 0.5)
For the mathUnimodel2PL174 evaluated via SE.type = 'MHRM'
```{r}
#library(dplyr)
#library(janitor)
#library(tidyr)
# Extract parameters with SE from the fitted mirt model
tmp <- coef(mathUnimodel2PL174, as.data.frame = TRUE, IRTpars = TRUE, printSE = TRUE)

# Round the parameters
tmp <- round(tmp, 2)

# Keep only complete cases
tmp <- tmp[complete.cases(tmp), ]

# Convert 'tmp' to a data frame before using rownames_to_column
tmp <- as.data.frame(tmp)

# Now you can safely move rownames (e.g., "Q001.a", "Q001.b") into a column
tmp <- tibble::rownames_to_column(tmp, var="item_param")

# Separate the qid (e.g., "Q001") and parameter type (e.g., "a" or "b")
tmp <- tmp %>% 
  separate(item_param, into = c("qid", "param"), sep="\\.")

# Pivot from long to wide format, putting 'a' and 'b' parameters and their SEs 
# into separate columns
final_tmp <- tmp %>%
  select(qid, param, par, SE) %>%
  pivot_wider(
    id_cols = qid,
    names_from = param,
    values_from = c(par, SE),
    names_glue = "{param}_{.value}"
  ) %>%
  select(qid, a_par, a_SE, b_par, b_SE)

# Add a new column for the assigned difficulty level for each item
final_tmp <- cbind(final_tmp, diffAssigned = NA)

# Assign difficulty levels based on the qid values
final_tmp[final_tmp[, "qid"] %in% 
                    math_MEDIUM_items1stAtt_vector, "diffAssigned"] <- 'MEDIUM'
final_tmp[final_tmp[, "qid"] %in% 
                    math_EASY_items1stAtt_vector, "diffAssigned"] <- 'EASY'
final_tmp[final_tmp[, "qid"] %in% 
                    math_HARD_items1stAtt_vector, "diffAssigned"] <- 'HARD'
# Print the resulting matrix
mathUnimodel2PL174_Parameters <- print(final_tmp)
write.table(mathUnimodel2PL174_Parameters, 
            'mathUnimodel2PL174_Parameters.csv', sep = ',')
```

#### a-pars: min = -0.36, max = 2.98; SE [0.08, 1.09] 
We want all items to discriminate at a higher value than 0.5
14% (24 out 174) of items do not discriminate well.
Check the range of 'a' parameter
```{r}
range(mathUnimodel2PL174_Parameters$a_par, na.rm = TRUE)
range(mathUnimodel2PL174_Parameters$a_SE, na.rm = TRUE)
```

##### Density plots
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL174_Parameters, aes(x = a_par,
                        color = "All 174 Items", linetype = "All 174 Items"),
                            linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "HARD"),
    aes(x = a_par, color = "89 Hard Items", linetype = "89 Hard Items"),
    linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "MEDIUM"),
  aes(x = a_par, color = "42 Medium Items", linetype = "42 Medium Items"),
  linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "EASY"),
  aes(x = a_par, color = "42 Easy Items", linetype = "42 Easy Items"),
  linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 174 Items" = "black",
  "89 Hard Items" = "black", "42 Medium Items" = "black",
  "42 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 174 Items" = "solid",
  "89 Hard Items" = "solid", "42 Medium Items" = "dashed",
  "42 Easy Items" = "dotted")) +
  labs(title = "Density Plots of a-parameters by Assigned-difficulty Level, AnSamp1",
       x = "a-parameter",
       y = "Density") +
          theme_minimal() +
                theme(
    legend.position = c(0.8, 0.8)  # Adjust legend position inside the plot
  )
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of a-parameters of 174 Math Items_AnSamp1.pdf")
```

##### Boxplots  with consistent y-axis limits 
```{r}
# library(gridExtra)
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL174_Parameters$a_par, na.rm = TRUE)

# Generate boxplots
boxplot_all_tmp <- 
  ggplot(mathUnimodel2PL174_Parameters, aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "174 Items", x = "", y = "a-parameter") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_hard_tmp <- 
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "HARD"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "89 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_medium_tmp <- 
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "MEDIUM"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_easy_tmp <- 
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "EASY"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "42 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of a-parameters of 174 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```


##### a-pars SEs

###### Density plots for Standard Errors for a-parameters
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL174_Parameters,
               aes(x = a_SE, color = "174 Items",
      linetype = "174 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "HARD"),
  aes(x = a_SE, color = "89 Hard Items", linetype = "89 Hard Items"),
  linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "MEDIUM"),
  aes(x = a_SE, color = "42 Medium Items", linetype = "42 Medium Items"),
  linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "EASY"),
  aes(x = a_SE, color = "42 Easy Items", linetype = "42 Easy Items"),
  linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("174 Items" = "black",
  "89 Hard Items" = "black", "42 Medium Items" = "black",
  "42 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("174 Items" = "solid",
  "89 Hard Items" = "solid", "42 Medium Items" = "dashed",
  "42 Easy Items" = "dotted")) +
  labs(title =
        "Density Plots of Standard Errors for a-Parameters by Assigned-Difficulty Level, AnSamp1",
       x = "a-parameter SE",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of Standard Errors for a-parameters from 174 Math Items_AnSamp1.pdf")
```

###### Boxplots for Standard Errors for a-parameters
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL174_Parameters$a_SE, na.rm = TRUE)

# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL174_Parameters, aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "174 Items", x = "", y = "a-parameter SE") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_hard_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                              diffAssigned == "HARD"),
                       aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "89 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_medium_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                                diffAssigned == "MEDIUM"),
                         aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_easy_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                              diffAssigned == "EASY"),
                       aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "42 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

# Save the multiplot with four boxplots as a PDF
ggsave(filename = 
"Box Plots of a-parameters' Standard Errors for 174 Math Items_AnSamp1.pdf",
        plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, 
                            boxplot_easy_tmp, ncol = 4))
```

#### b-pars: min = -3.88, max = 19.63; SE [0.03, 100.38] 
b-Parameters
```{r}
range(mathUnimodel2PL174_Parameters$b_par)
range(mathUnimodel2PL174_Parameters$b_SE)
```

##### Density plots
```{r}
 ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL174_Parameters, aes(x = b_par,
        color = "All 174 Items", linetype = "All 174 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL174_Parameters, diffAssigned == "HARD"),
     aes(x = b_par, color = "90 Hard Items", linetype = "90 Hard Items"),
     linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "MEDIUM"),
               aes(x = b_par, color = "42 Medium Items", linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL174_Parameters, diffAssigned == "EASY"),
               aes(x = b_par, color = "42 Easy Items", linetype = "42 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 174 Items" = "black",
                                                 "90 Hard Items" = "black",
                                                 "42 Medium Items" = "black",
                                                 "42 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 174 Items" = "solid",
                                                    "90 Hard Items" = "solid",
                                                    "42 Medium Items" = "dashed",
                                                    "42 Easy Items" = "dotted")) +
  labs(title = "Density Plots of b-parameters by Assigned Difficulty Level, AnSamp1",
       x = "b-parameter",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of b-parameters of 174 Math Items_AnSamp1.pdf")
```

##### Boxplots
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL174_Parameters$b_par, na.rm = TRUE)

# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL174_Parameters, aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "All 174 Items", x = "", y = "b-parameter") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_hard_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                              diffAssigned == "HARD"),
                       aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "90 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_medium_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                                diffAssigned == "MEDIUM"),
                         aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_easy_tmp <- ggplot(subset(mathUnimodel2PL174_Parameters,
                              diffAssigned == "EASY"),
                       aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "42 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of b-parameters of 174 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```

##### b-pars SEs

###### Density plots for Standard Errors for b-parameters
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL174_Parameters, aes(x = b_SE,
        color = "All 174 Items", linetype = "All 174 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL174_Parameters, diffAssigned == "HARD"),
               aes(x = b_SE, color = "90 Hard Items", linetype = "90 Hard Items"),
               linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL174_Parameters,
                             diffAssigned == "MEDIUM"),
               aes(x = b_SE, color = "42 Medium Items", linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL174_Parameters, diffAssigned == "EASY"),
               aes(x = b_SE, color = "42 Easy Items", linetype = "42 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 174 Items" = "black",
                                                 "90 Hard Items" = "black",
                                                 "42 Medium Items" = "black",
                                                 "42 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 174 Items" = "solid",
                                                    "90 Hard Items" = "solid",
                                                    "42 Medium Items" = "dashed",
                                                    "42 Easy Items" = "dotted")) +
  labs(title =
         "Density Plots of Standard Errors for b-Parameters by Assigned-Difficulty Level, AnSamp1",
       x = "b-parameter SE",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of Standard Errors for b-parameters from 174 Math Items_AnSamp1.pdf")
```

###### Boxplots  with consistent y-axis limits 
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL174_Parameters$b_SE, na.rm = TRUE)

# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL174_Parameters, aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "All 174 Items", x = "", y = "b-parameter SE") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_hard_tmp <-
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "HARD"),
                       aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "90 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_medium_tmp <-
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "MEDIUM"),
                         aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_easy_tmp <-
  ggplot(subset(mathUnimodel2PL174_Parameters, diffAssigned == "EASY"),
                       aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "42 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of Standard Errors for b-parameters of 174 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```

### Theta scores (F-scores in "mirt") from 174-Items 2PL Model are normally distributed
Probable Reasons for a very-close-to-normal distribution of thetas:
- Adaptive Format:
Adaptive testing minimizes measurement error by selecting items that closely 
match the test-taker's ability, leading to more accurate and normal distributions 
of theta scores. Reference: van der Linden, W. J., & Glas, C. A. W. (Eds.). 
(2010). Elements of Adaptive Testing. Springer. Key Insight: This book outlines 
the mechanics of adaptive testing and explains how it optimizes the precision of 
ability estimates.
- Broad Difficulty Range:
A test designed with varying difficulty levels provides better discrimination 
across a wider range of abilities, supporting a more normal theta distribution.
Reference: Embretson, S. E., & Reise, S. P. (2013). Item Response Theory for 
Psychologists. Psychology Press. Key Insight: This book discusses how well-
distributed item difficulties lead to better reliability and theta distributions.
- Simple, Unidimensional Model:
Unidimensional IRT assumes that all items measure a single latent trait, making 
it less prone to local dependencies or other artifacts that could skew 
distributions. Reference: Hambleton, R. K., Swaminathan, H., & Rogers, H. J. 
(1991). Fundamentals of Item Response Theory. SAGE Publications. Key Insight: 
Describes the advantages of unidimensional models for producing clear and 
interpretable ability estimates.

#### M = -0.0014, SD = 0.89
Central tendency characteristics
```{r}
Theta_math174<-fscores(mathUnimodel2PL174,full.scores.SE=T)
# Ensure the data is in a data frame format
Theta_math174 <- data.frame(Theta_math174)

# Add the variable of DAACS_ID to the dataframe with thetas:
Theta_math174$DAACS_ID<-math.items_AnSamp1DAACS_ID_vector
# Rename the columns
names(Theta_math174)<-c("Theta_math174", "SE_Theta_math174", "DAACS_ID")
#Save theta estimates to external file:
write.csv(Theta_math174,
          "Theta_math174.csv",quote=F,row.names=F)
# Calculate mean and standard deviation
mean_valueThetas_174 <- mean(Theta_math174$Theta_math174, na.rm = TRUE)
sd_valueThetas_174 <- sd(Theta_math174$Theta_math174, na.rm = TRUE)
mean_valueThetas_174 # -0.0014
sd_valueThetas_174 # 0.89
```

#### Histogram
```{r}
# Function to create a histogram with legend and left-aligned footnote for SD
create_histogram <- function(data, variable, mean_value, sd_value, title_prefix, output_file) {
  # Convert the variable name to a symbol for dynamic use in ggplot2
  variable_sym <- rlang::sym(variable)
  
  # Ensure non-exponential format for mean and SD
  mean_str <- sprintf("%.4f", mean_value)
  mean_sd_minus_str <- sprintf("%.4f", mean_value - sd_value)
  mean_sd_plus_str <- sprintf("%.4f", mean_value + sd_value)
  sd_str <- sprintf("%.4f", sd_value)

  # Create the histogram
  hist_plot <- ggplot(data, aes(x = !!variable_sym)) +
    geom_histogram(
      binwidth = 0.5,
      fill = "lightblue",
      color = "black",
      alpha = 0.7
    ) +
    geom_vline(aes(xintercept = mean_value, color = "Mean"), 
               linetype = "dashed", size = 1) +
    geom_vline(aes(xintercept = mean_value + sd_value, color = "Mean + SD"), 
               linetype = "dotted", size = 1) +
    geom_vline(aes(xintercept = mean_value - sd_value, color = "Mean - SD"), 
               linetype = "dotted", size = 1) +
    scale_color_manual(
      name = NULL,  # Remove legend title
      values = c("Mean" = "black", "Mean - SD" = "black", "Mean + SD" = "black"),
      labels = c(
        paste0("Mean = ", mean_str),
        paste0("Mean - SD = ", mean_sd_minus_str),
        paste0("Mean + SD = ", mean_sd_plus_str)
      )
    ) +
    labs(
      title = paste0(title_prefix, " (n = ", nrow(data), ")"),
      x = variable,
      y = "Frequency",
      caption = paste0("SD = ", sd_str)  # Add left-aligned footnote for SD
    ) +
    theme_minimal() +
    theme(
      legend.position = c(0.95, 0.95), # Place legend in upper-right corner
      legend.justification = c("right", "top"),
      legend.background = element_blank(),  # No frame around legend
      legend.key = element_blank(),  # No key background
      plot.caption = element_text(hjust = 0, size = 10, face = "italic")  # Left-aligned footnote
    )
  
  # Save the plot as a PDF
  ggsave(
    filename = output_file,
    plot = hist_plot,
    width = 8,
    height = 6
  )
  
  # Display the plot inline in R Markdown or RStudio Plots pane
  hist_plot
}

# Example usage
# Assuming your dataframe is `math.items_AnSamp1` with a variable `Theta_math174`
mathUnimodel2PL174_AnSamp1_theta_hist<-create_histogram(
  data = Theta_math174,
  variable = "Theta_math174",
  mean_value = mean(Theta_math174$Theta_math174),
  sd_value = sd(Theta_math174$Theta_math174),
  title_prefix = "Distribution of Theta-Scores from AnSamp1 using 174 DAACS Math Items",
  output_file = "mathUnimodel2PL174_AnSamp1_theta_histogram.pdf"
)
mathUnimodel2PL174_AnSamp1_theta_hist
```

#### Add the variable of Theta-scores to math.items_AnSamp1
```{r}
math.items_AnSamp1<-merge(math.items_AnSamp1,Theta_math174[,c("Theta_math174","DAACS_ID")])
```

## 159-item Unimodels: 15 items were removed due to poor parameters:   
a-parameters < 0.3 or > 4, and |b-parameters| > 6
Run every model using the MHRM type of SE (for stochastic approximations of 
observed information matrix based on the Robbins-Monro filter or a fixed 
number of MHRM draws without the RM filter)

### 1PL Model
Remove 15 items with poor parameters 
```{r}
math.items_159_umgc1ua2<-
  math.itemsONLY_AnSamp1[,-c(8,11,13,17,70,73,79,82,106,123,128,130,
                                         132,168,170)]

# mathUnimodel1PL159 <- mirt(math.items_159_umgc1ua2,
#                            model = 1,
#                            itemtype = 'Rasch',
#                            method = 'MHRM', SE = TRUE,
#                            SE.type = 'MHRM',
#                            # technical = list(NCYCLES = 1000),
#                            TOL = 1e-03,
#                            verbose = TRUE)
mathUnimodel1PL159
extract.mirt(mathUnimodel1PL159,"converged")
# [1] TRUE
```

### 2PL Model
```{r}
# mathUnimodel2PL159 <- mirt(math.items_159_umgc1ua2,
#                            model = 1,
#                            itemtype = '2PL',
#                            method = 'MHRM', SE = TRUE,
#                            SE.type = 'MHRM',
#                            # technical = list(NCYCLES = 1000),
#                            TOL = 1e-03,
#                            verbose = TRUE)
mathUnimodel2PL159
extract.mirt(mathUnimodel2PL159,"converged")
```

### ANOVA: 2PL Model fits better than 1PL; 159- fits better than 174- and 
167-item models.
```{r}
anova(mathUnimodel1PL159,mathUnimodel2PL159)
```

### Local Dependency Q3 Residuals improved: 159-items model fits better than  
174- and 167-item model:

```{r}
# Q3 summary statistics
mathUnimodel2PL159_LocalResiduals_Q3<-
  residuals(mathUnimodel2PL159,type='Q3')
# Save the file
#library(openxlsx)
write.xlsx(mathUnimodel2PL159_LocalResiduals_Q3, 
           file = "mathUnimodel2PL159_Residuals_Q3.xlsx", rowNames = TRUE)
```

### Parameters: 1 item had a<0.3, and all items had |b|<2.4; 6% (10 out 159) of items discriminate weakly (a-par < 0.5)
For the mathUnimodel2PL159 evaluated via SE.type = 'MHRM'
```{r}
# Extract parameters with SE from the fitted mirt model
tmp <- coef(mathUnimodel2PL159, as.data.frame = TRUE, IRTpars = TRUE, printSE = TRUE)
# Round the parameters
tmp <- round(tmp, 2)
# Keep only complete cases
tmp <- tmp[complete.cases(tmp), ]
# Convert 'tmp' to a data frame before using rownames_to_column
tmp <- as.data.frame(tmp)
# safely move rownames (e.g., "Q001.a", "Q001.b") into a column
tmp <- tibble::rownames_to_column(tmp, var="item_param")
# Separate the qid (e.g., "Q001") and parameter type (e.g., "a" or "b")
tmp <- tmp %>% 
  separate(item_param, into = c("qid", "param"), sep="\\.")
# Pivot from long to wide format, putting 'a' and 'b' parameters and their SEs into separate columns
final_tmp <- tmp %>%
  select(qid, param, par, SE) %>%
  pivot_wider(
    id_cols = qid,
    names_from = param,
    values_from = c(par, SE),
    names_glue = "{param}_{.value}"
  ) %>%
  select(qid, a_par, a_SE, b_par, b_SE)
# Add a new column for the assigned difficulty level for each item
final_tmp <- cbind(final_tmp, diffAssigned = NA)
# Assign difficulty levels based on the qid values
final_tmp[final_tmp[, "qid"] %in% 
            math_MEDIUM_items1stAtt_vector, "diffAssigned"] <- 'MEDIUM'
final_tmp[final_tmp[, "qid"] %in% 
            math_EASY_items1stAtt_vector, "diffAssigned"] <- 'EASY'
final_tmp[final_tmp[, "qid"] %in% 
            math_HARD_items1stAtt_vector, "diffAssigned"] <- 'HARD'
# Print the resulting matrix
mathUnimodel2PL159_Parameters <- print(final_tmp)
write.table(mathUnimodel2PL159_Parameters, 
            'mathUnimodel2PL159_Parameters.csv', sep = ',')
```
#### a-Pars improved: min = 0.16, max = 3.19; SE [0.08, 0.73] 
6% (10 out 159) of items discriminate weakly (a-par < 0.5)
Range of 'a' parameter
```{r}
range(mathUnimodel2PL159_Parameters$a_par, na.rm = TRUE)
range(mathUnimodel2PL159_Parameters$a_SE, na.rm = TRUE)
```
##### Density plots 
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL159_Parameters, aes(x = a_par,
                          color = "All 159 Items", linetype = "All 159 Items"),
               linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "HARD"),
            aes(x = a_par, color = "86 Hard Items", linetype = "86 Hard Items"),
               linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "MEDIUM"),
        aes(x = a_par, color = "42 Medium Items", linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "EASY"),
            aes(x = a_par, color = "31 Easy Items", linetype = "31 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 159 Items" = "black",
                                                 "86 Hard Items" = "black", 
                                                 "42 Medium Items" = "black",
                                                 "31 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 159 Items" = "solid",
                                                    "86 Hard Items" = "solid", 
                                                   "42 Medium Items" = "dashed",
                                                  "31 Easy Items" = "dotted")) +
  labs(title = "Density Plots of a-parameters by Assigned-Difficulty Level, AnSamp1",
       x = "a-parameter",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of a-parameters of 159 Math Items_AnSamp1.pdf")
```
##### Boxplots 
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL159_Parameters$a_par, na.rm = TRUE)
# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL159_Parameters, aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "159 Items", x = "", y = "a-parameter") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_hard_tmp <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "HARD"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "86 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_medium_tmp <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "MEDIUM"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_easy_tmp <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "EASY"),
         aes(x = factor(1), y = a_par)) +
  geom_boxplot() +
  labs(title = "31 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of a-parameters of 159 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```

###### Density plots SEs for a-pars
for Standard Errors for a-parameters
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL159_Parameters,
               aes(x = a_SE, color = "159 Items",
                   linetype = "159 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "HARD"),
            aes(x = a_SE, color = "86 Hard Items", linetype = "86 Hard Items"),
               linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "MEDIUM"),
               aes(x = a_SE, color = "42 Medium Items", 
                   linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "EASY"),
            aes(x = a_SE, color = "31 Easy Items", linetype = "31 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("159 Items" = "black",
                                                 "86 Hard Items" = "black", 
                                                 "42 Medium Items" = "black",
                                                 "31 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("159 Items" = "solid",
                                                  "86 Hard Items" = "solid", 
                                                  "42 Medium Items" = "dashed",
                                                  "31 Easy Items" = "dotted")) +
  labs(title =
         "Density Plots of Standard Errors for a-Parameters by Assigned-Difficulty Level, AnSamp1",
       x = "a-parameter SE",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of Standard Errors for a-parameters from 159 Math Items_AnSamp1.pdf")
```

###### Boxplots SEs for a-pars
Boxplots  with consistent y-axis limits for Standard Errors for a-parameters
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL159_Parameters$a_SE, na.rm = TRUE)
# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL159_Parameters, aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "159 Items", x = "", y = "a-parameter SE") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_hard_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                              diffAssigned == "HARD"),
                       aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "86 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_medium_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                                diffAssigned == "MEDIUM"),
                         aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_easy_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                              diffAssigned == "EASY"),
                       aes(x = factor(1), y = a_SE)) +
  geom_boxplot() +
  labs(title = "31 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of Standard Errors for b-parameters of 159 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```

#### b-Pars improved: min = -2.31, max = 2.06; SE [0.04, 2.75] 
```{r}
range(mathUnimodel2PL159_Parameters$b_par)
range(mathUnimodel2PL159_Parameters$b_SE)
```

##### Density plots
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL159_Parameters, aes(x = b_par,
                                                         color = "All 159 Items", linetype = "All 159 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL159_Parameters, diffAssigned == "HARD"),
               aes(x = b_par, color = "86 Hard Items", linetype = "86 Hard Items"),
               linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "MEDIUM"),
               aes(x = b_par, color = "42 Medium Items", linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL159_Parameters, diffAssigned == "EASY"),
               aes(x = b_par, color = "31 Easy Items", linetype = "31 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 159 Items" = "black",
                                                 "86 Hard Items" = "black",
                                                 "42 Medium Items" = "black",
                                                 "31 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 159 Items" = "solid",
                                                    "86 Hard Items" = "solid",
                                                    "42 Medium Items" = "dashed",
                                                    "31 Easy Items" = "dotted")) +
  labs(title = "Density Plots of b-parameters by Assined-Difficulty Level, AnSamp1",
       x = "b-parameter",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of b-parameters from 159 Math Items_AnSamp1.pdf")
```
##### Boxplots
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL159_Parameters$b_par, na.rm = TRUE)
# Generate boxplots
boxplot_all_tmp <-
  ggplot(mathUnimodel2PL159_Parameters, aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "All 159 Items", x = "", y = "b-parameter") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_hard_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                              diffAssigned == "HARD"),
                       aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "86 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
boxplot_medium_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                                diffAssigned == "MEDIUM"),
                         aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)

boxplot_easy_tmp <- ggplot(subset(mathUnimodel2PL159_Parameters,
                              diffAssigned == "EASY"),
                       aes(x = factor(1), y = b_par)) +
  geom_boxplot() +
  labs(title = "31 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of b-parameters of 159 Math Items_AnSamp1.pdf",
       plot = grid.arrange(boxplot_all_tmp, boxplot_hard_tmp, boxplot_medium_tmp, boxplot_easy_tmp, ncol = 4))
```

###### Density plots SEs for b-pars
```{r}
ggplot() +
  # Density plot for all items
  geom_density(data = mathUnimodel2PL159_Parameters, aes(x = b_SE,
                                                         color = "All 159 Items", linetype = "All 159 Items"), linewidth = 1.5) +
  # Density plot for hard items
  geom_density(data = subset(mathUnimodel2PL159_Parameters, diffAssigned == "HARD"),
               aes(x = b_SE, color = "86 Hard Items", linetype = "86 Hard Items"),
               linewidth = 1) +
  # Density plot for medium items
  geom_density(data = subset(mathUnimodel2PL159_Parameters,
                             diffAssigned == "MEDIUM"),
               aes(x = b_SE, color = "42 Medium Items", linetype = "42 Medium Items"),
               linewidth = 1) +
  # Density plot for easy items
  geom_density(data = subset(mathUnimodel2PL159_Parameters, diffAssigned == "EASY"),
               aes(x = b_SE, color = "31 Easy Items", linetype = "31 Easy Items"),
               linewidth = 1) +
  scale_color_manual(name = "Legend", values = c("All 159 Items" = "black",
                                                 "86 Hard Items" = "black",
                                                 "42 Medium Items" = "black",
                                                 "31 Easy Items" = "black")) +
  scale_linetype_manual(name = "Legend", values = c("All 159 Items" = "solid",
                                                    "86 Hard Items" = "solid",
                                                    "42 Medium Items" = "dashed",
                                                    "31 Easy Items" = "dotted")) +
  labs(title =
         "Density Plots of Standard Errors for b-Parameters by Assigned Difficulty Level, AnSamp1",
       x = "b-parameter SE",
       y = "Density") +
  theme_minimal()+
                theme(
    legend.position = c(0.8, 0.8))
# Save the plot as a PDF
ggsave(filename = 
"Density Plots of Standard Errors for b-parameters from 159 Math Items_AnSamp1.pdf")
```
###### Boxplots SEs for b-pars
```{r}
# Determine the range for the y-axis
y_limits_tmp <- range(mathUnimodel2PL159_Parameters$b_SE, na.rm = TRUE)
# Generate boxplots
mathUnimodel2PL159_AnSamp1_AllitemPar_boxplots <-
  ggplot(mathUnimodel2PL159_Parameters, aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "All 159 Items", x = "", y = "b-parameter SE") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
mathUnimodel2PL159_AnSamp1_hardItemPar_boxplots <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "HARD"),
         aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "86 Hard Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
mathUnimodel2PL159_AnSamp1_medItemPar_boxplots <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "MEDIUM"),
         aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "42 Medium Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
mathUnimodel2PL159_AnSamp1_easyItemPar_boxplots <-
  ggplot(subset(mathUnimodel2PL159_Parameters, diffAssigned == "EASY"),
         aes(x = factor(1), y = b_SE)) +
  geom_boxplot() +
  labs(title = "31 Easy Items", x = "", y = "") +
  theme_minimal() +
  theme(axis.text.x = element_blank()) +
  ylim(y_limits_tmp)
# Save the multiplot with four boxplots as a PDF
ggsave(filename = "Box Plots of Standard Errors for b-parameters of 159 Math Items_AnSamp1.pdf",
       plot = grid.arrange(mathUnimodel2PL159_AnSamp1_AllitemPar_boxplots, mathUnimodel2PL159_AnSamp1_hardItemPar_boxplots, mathUnimodel2PL159_AnSamp1_medItemPar_boxplots, mathUnimodel2PL159_AnSamp1_easyItemPar_boxplots, ncol = 4))
```

## Expected Scores Plots

#### Total Scores 
```{r}
plot(mathUnimodel2PL174)
plot(mathUnimodel2PL159)
```

### Items' Scores - IRT Plots 
```{r save_plot, echo=TRUE, fig.cap="Item Score Plot"}
# Save the plot as a PDF
pdf("IRT_Plots_174MathScores_AnSamp1.pdf")

# Generate the plot
plot(mathUnimodel2PL174, type = 'itemscore')

# Close the PDF device
dev.off()

# Display the plot inline in the R Markdown output
mathUnimodel2PL_AnSamp1_174irtPlots<- 
  plot(mathUnimodel2PL174, type = 'itemscore')
```

```{r save_plot_reduced, echo=TRUE, fig.cap="Item Score Plot"}
# Save the plot as a PDF
pdf("IRT_Plots_159MathScores_AnSamp1.pdf")

# Generate the plot
plot(mathUnimodel2PL159, type = 'itemscore')

# Close the PDF device
dev.off()

# Display the plot inline in the R Markdown output
mathUnimodel2PL_AnSamp1_159irtPlots<- 
  plot(mathUnimodel2PL159, type = 'itemscore')
```

#### Expected Bandle Score for the first six items
##### To Do: Expected Bandle Score for all Hard, all Easy, and all Medium items 
```{r}
plot(mathUnimodel2PL174, which.items = 1:6,drop.zeros = TRUE)
# # Selected items' expected scores (didn't work)
# plot(mathUnimodel2PL174, type = 'itemscore', which.items = 7:12,drop.zeros = TRUE)
# # Empirical Plots (didn't work')
# empirical_plot(math.items_174_umgc1ua2,which.items = 2:6)
# empirical_plot(math.items_174_umgc1ua2)
# empirical_plot(math.items_174_umgc1ua2, type = 'hist',breaks=20, drop.zeros = TRUE)
# empirical_plot(math.items_174_umgc1ua2, c(1, 2, 5), smooth = TRUE,drop.zeros = TRUE)
# empirical_plot(math.items_174_umgc1ua2, c(1, 2, 5), type = 'boxplot',drop.zeros = TRUE)
```

## Distributions of Theta-scores in two models (174 and 159 items)

### Theta scores from 159-Items 2PL Model are normally distributed
Central tendency characteristics: M = -0.001, SD = 0.89
#### M = -0.001, SD = 0.89
```{r}
Theta_math159<-fscores(mathUnimodel2PL159,full.scores.SE=T)
# Ensure the data is in a data frame format
Theta_math159 <- data.frame(Theta_math159)

# Add the variable of DAACS_ID to the dataframe with thetas:
Theta_math159$DAACS_ID<-math.items_AnSamp1DAACS_ID_vector
# Rename the columns
names(Theta_math159)<-c("Theta_math159", "SE_Theta_math159", "DAACS_ID")
#Save theta estimates to external file:
write.csv(Theta_math159,
          "Theta_math159.csv",quote=F,row.names=F)
# Calculate mean and standard deviation
mean_valueThetas_159 <- mean(Theta_math159$Theta_math159, na.rm = TRUE)
sd_valueThetas_159 <- sd(Theta_math159$Theta_math159, na.rm = TRUE)
mean_valueThetas_159 # -0.001
sd_valueThetas_159 # 0.89
```

#### Add the variable to math.items_AnSamp1 
```{r}
math.items_AnSamp1<-merge(math.items_AnSamp1,Theta_math159[,c("Theta_math159", "DAACS_ID")])

# Move the theta scores to the beginning of the dataframe
math.items_AnSamp1<- 
  math.items_AnSamp1[,c(1:20, 197, 196, 21:195)]
```

#### Histogram of Theta-scores
```{r}
mathUnimodel2PL159_AnSamp1_theta_hist<-create_histogram(
  data = math.items_AnSamp1,
  variable = "Theta_math159",
  mean_value = mean(math.items_AnSamp1$Theta_math159),
  sd_value = sd(math.items_AnSamp1$Theta_math159),
  title_prefix = "Distribution of Theta-Scores from AnSamp1 using 159 DAACS Math Items",
  output_file = "mathUnimodel2PL159_AnSamp1_theta_histogram.pdf"
)
mathUnimodel2PL159_AnSamp1_theta_hist
```

### Theta scores from 174-Items 2PL Model are normally distributed

#### Density Plots of Theta-scores overlap fully 

```{r}

# Function to create two density plots of the correlated measures in a single chart
densityPlot_2corMeasures <- function(data1_tmp, data2_tmp, 
                                     label1_tmp = "Measure 1",
                                     label2_tmp = "Measure 2",
                                     x_label_tmp = "Values",
                                     footnote = "",
                                     output_file = "MathThetaScores159and174_AnSamp1_4460Density.pdf") {
  # Ensure both data vectors have the same length
  if (length(data1_tmp) != length(data2_tmp)) {
    stop("Both data vectors must have the same length.")
  }

  # Calculate statistics for each measure
  mean1 <- mean(data1_tmp, na.rm = TRUE)
  sd1 <- sd(data1_tmp, na.rm = TRUE)

  mean2 <- mean(data2_tmp, na.rm = TRUE)
  sd2 <- sd(data2_tmp, na.rm = TRUE)

  # Sample size
  n_samples <- nrow(Theta_math174)

  # Create the density plot
  density_plot <- ggplot() +
    # Density plot for data1_tmp
    geom_density(aes(x = data1_tmp, color = label1_tmp, fill = label1_tmp), alpha = 0.25, linewidth = 1, adjust = 1.5) +
    # Density plot for data2_tmp
    geom_density(aes(x = data2_tmp, color = label2_tmp, fill = label2_tmp), alpha = 0.25, linewidth = 1, adjust = 1.5) +
    # Add mean lines
    geom_vline(aes(xintercept = mean1, color = label1_tmp), linetype = "dotted", linewidth = 1) +
    geom_vline(aes(xintercept = mean2, color = label2_tmp), linetype = "dashed", linewidth = 1) +
    # Custom color and fill scales
    scale_color_manual(
      values = setNames(c("blue", "green"), c(label1_tmp, label2_tmp)),
      name = "Measures",
      labels = c(
        sprintf("%s (Mean = %.2f, SD = %.2f)", label1_tmp, mean1, sd1),
        sprintf("%s (Mean = %.2f, SD = %.2f)", label2_tmp, mean2, sd2)
      )
    ) +
    scale_fill_manual(
      values = setNames(c("blue", "green"), c(label1_tmp, label2_tmp)),
      guide = "none"
    ) +
    # Add title, labels, and footnote
    labs(
      title = sprintf("Density Plots for Mathematics Theta Scores, Analytic Sample 1 (n = %d)", n_samples),
      x = x_label_tmp,
      y = "Density",
      caption = footnote
    ) +
    # Adjust theme for readability
    theme_minimal() +
    theme(
      legend.position = "top",
      legend.title = element_text(size = 12),
      legend.text = element_text(size = 10),
      plot.title = element_text(size = 14, face = "bold"),
      plot.caption = element_text(size = 9, hjust = 0)
    )

  # Display the plot
  print(density_plot)

  # Save the plot
  ggsave(output_file, plot = density_plot, width = 8, height = 6)
}

# Apply the function:
densityPlot_2corMeasures(
  data1_tmp = Theta_math174[, 1],
  data2_tmp = Theta_math159[, 1],
  label1_tmp = "Theta-scores from 174 Items",
  label2_tmp = "Theta-scores from 159 Items",
  x_label_tmp = "Theta-scores",
  footnote =
    "Note: Data collected in 2022-23 a.y. from UMGC and UAlbany non-speedy respondents",
  output_file = "MathThetaScores_DensityPlot_AnSamp1.pdf"
)
# Save the plot
ggsave(filename = "Density Plot of Math Theta Scores_AnSamp1.pdf", 
      width = 8, height = 6)
```
Note: The plot does not end abruptly at the right edge of the plot area. See the highest values of the Thetas.
```{r}
sort(Theta_math174$Theta_math174, decreasing = TRUE)[1:10]
sort(Theta_math159$Theta_math159, decreasing = TRUE)[1:10]
```


#### QQ tests: Both sets of Theta-scores were distributed close to normal distribution
Both plots show a reasonable fit to a normal distribution, especially around
the central values. However, the tails deviate slightly from normality, which
might imply issues such as heavier tails or some skewness. This could suggest
that both models capture the central tendency well but might need refinement
in capturing extreme score behaviors.

```{r}
# library(car)

# Save to PDF
pdf("QQ_Plots_Math_Theta_Scores_AnSamp1.pdf", width = 12, height = 8)

# Set layout and adjust margins
par(mfrow = c(1, 2), oma = c(2, 0, 2, 0), mar = c(5, 4, 4, 2))

# Generate QQ-plots for PDF
qqPlot(Theta_math174$Theta_math174, 
       main = "QQ Plot for 174-Item Thetas", 
       col = "blue", pch = 20, cex = 1.2)

qqPlot(Theta_math159$Theta_math159, 
       main = "QQ Plot for 159-Item Thetas", 
       col = "green", pch = 20, cex = 1.2)

# Add a title above the plots
mtext("QQ-plots for Math Theta Scores from 174 and 159 Items, AnSamp1", outer = TRUE, line = 0, cex = 1.5, font = 2)

# Add the footnote below the plots
mtext(
"Data collected from UMGC and UAlbany non-speedy respondents from July 2022 to May 2023", 
      outer = TRUE, line = -1.5, cex = 1, font = 3)

# Close PDF device
dev.off()

# Generate QQ-plots for R Markdown inline display
par(mfrow = c(1, 2), oma = c(2, 0, 2, 0), mar = c(5, 4, 4, 2)) # Adjust margins for inline display

# Inline plots
mathUnimodel2PL_umgc1ua2_Thetas174_qqPlot<-qqPlot(Theta_math174$Theta_math174, 
       main = "QQ Plot for 174-math-item Thetas", 
       col = "blue", pch = 20, cex = 1.2)

mathUnimodel2PL_umgc1ua2_Thetas159_qqPlot<-qqPlot(Theta_math159$Theta_math159, 
       main = "QQ Plot for 159-math-item Thetas", 
       col = "green", pch = 20, cex = 1.2)

# Reset graphical parameters
par(mfrow = c(1, 1)) 
```


###### Paired-samples t-test confirms no difference in Theta-scores distributions 
To test whether the distributions of two Theta-scores are different using a pared-samples t-test:
```{r}
# Wide format needed: one row per student
t.test(math.items_AnSamp1$Theta_math174, math.items_AnSamp1$Theta_math91, paired = TRUE)
```

#### ANOVA (t-test) confirms no difference in Theta-scores distributions 
To test whether the distributions of two Theta-scores are different using an 
ANOVA test, we need to prepare the data such that the two sets of Theta-scores 
are compared as groups within the same dataset. 
```{r}
mathUnimodel2PL_umgc1ua2_all_Thetas<- merge(Theta_math174,Theta_math159)

# Combine the two Theta-scores into one data frame with a grouping variable
Theta_data_tmp <- data.frame(
  Theta = c(mathUnimodel2PL_umgc1ua2_all_Thetas$Theta_math174, mathUnimodel2PL_umgc1ua2_all_Thetas$Theta_math159),
  Group = rep(c("Theta_math174", "Theta_math159"), 
              times = c(length(mathUnimodel2PL_umgc1ua2_all_Thetas$Theta_math174), length(mathUnimodel2PL_umgc1ua2_all_Thetas$Theta_math159)))
)

# Run an ANOVA test
anova(lm(Theta ~ Group, data = Theta_data_tmp))
```

## Item Fit does not work due to missing values

If we try to run S_X2, Error: Only X2, G2, PV_Q1, PV_Q1*, infit, X2*, and X2*_df 
can be computed with missing data. Pass na.rm=TRUE to remove missing data row-wise.
For X2 and G2, "PV_Q1","PV_Q1*": EM cycles terminated after 500 iterations. 
EM cycles terminated after 500 iterations. Warning messages:
 1: In sqrt(colSums((pf$C/pf$W^2)/n^2) - 1/n): NaNs produced. 
 2: In sqrt(colSums(pf$C - pf$W^2)/colSums(pf$W)^2) : NaNs produced.
```{r}
# itemfit(mathUnimodel2PL174, c( "infit", "X2*", "X2*_df")) # good fit, long time
# itemfit(mathUnimodel2PL159, c( "infit", "X2*", "X2*_df")) # good fit, long time
```

# Save all data in a single file 
```{r}
#save.image("D:/Dropbox/DAACS-Validity/Analyses/Math/Math_dataClean-UMGC1UA2_2.RData")
save.image("C:/Users/orosc/OneDrive - University at Albany - SUNY/My DAACS/math/Math_dataClean-umgc1ua2_2.RData")
```
